<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘»åŒç¾©è©ã®é¬¼ğŸ‘»</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a9396">
    



    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { color: #2c3e50; margin-bottom: 5px; }
        p { color: #7f8c8d; margin-bottom: 20px; font-size: 0.9rem; }
        
        /* ç‹€æ…‹åˆ— */
        .info-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #34495e;
            font-weight: bold;
            background: white;
            padding: 10px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ç”¨æˆ¶æ­¡è¿å€ */
        .user-panel {
            background: #dff9fb; color: #2c3e50; 
            padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;
            display: flex; gap: 10px; align-items: center;
            border: 1px solid #b2bec3;
        }
        .logout-btn {
            background: none; border: none; color: #e74c3c; 
            cursor: pointer; text-decoration: underline; font-size: 0.85rem;
        }

        .stat-box { display: flex; align-items: center; gap: 6px; white-space: nowrap;}
        .score-box { color: #2980b9; }
        
        #lives { color: #e74c3c; transition: all 0.3s; }
        .low-health { animation: pulse-red 0.8s infinite; }

        @keyframes pulse-red {
            0% { text-shadow: 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
            50% { text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); transform: scale(1.1); }
            100% { text-shadow: 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
        }

        /* --- éŠæˆ²ç¶²æ ¼ --- */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 680px;
            width: 100%;
        }

        /* --- å¡ç‰‡æ¨£å¼ --- */
        .card {
            background-color: transparent;
            height: 120px;
            perspective: 1000px;
            cursor: pointer;
            user-select: none;
        }

        /* --- Result Page Styles --- */
        .result-level-title {
            background: #2c3e50; color: white;
            padding: 8px 15px; border-radius: 8px;
            margin: 20px 0 10px 0; font-weight: bold;
            font-size: 1rem; display: inline-block;
        }

        .result-group-box {
            border: 2px solid #eee; border-radius: 12px;
            padding: 12px; margin-bottom: 12px;
            background: #fff; position: relative;
            overflow: hidden;
        }

.result-meaning {
    font-weight: 900; 
    font-size: 1.1rem; 
    margin-bottom: 8px;
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    width: 100%;
}

        .result-words-flex {
            display: flex; flex-wrap: wrap; gap: 8px; align-items: baseline;
        }

        /* éŠæˆ²ä¸­å‡ºç¾éçš„å­— (é¡¯çœ¼) */
        .word-badge.active {
            font-size: 1.1rem; font-weight: bold;
            padding: 6px 12px; border-radius: 20px;
            color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.2s;
            border: 2px solid rgba(0,0,0,0.1);
        }
        .word-badge.active:hover { transform: scale(1.1); }

        /* åŒçµ„ä½†æ²’å‡ºç¾çš„å­— (æš—æ·¡) */
        .word-badge.passive {
            font-size: 0.85rem; color: #95a5a6;
            padding: 4px 8px; border: 1px dashed #bdc3c7;
            border-radius: 15px; background: #f8f9fa;
            cursor: pointer; opacity: 0.8;
        }
        .word-badge.passive:hover { opacity: 1; border-color: #7f8c8d; background: #eee; }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 12px;
        }

        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card.matched .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            padding: 5px;
            box-sizing: border-box;
        }

        .card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
            transition: font-size 0.3s ease;
            font-family: 'Courier New', Courier, monospace; 
            font-weight: bold;
        }

        .card-front {
            background-color: white;
            color: #333; 
            transform: rotateY(180deg);
            border: 2px solid #ddd; 
            font-weight: bold;
            z-index: 1;
        }

        .word-text { font-size: 1.1rem; margin-bottom: 8px; line-height: 1.2; }
        .long-text { font-size: 0.9rem; }

        .meaning-text {
            font-size: 0.9rem;
            opacity: 0; 
            transform: translateY(10px);
            transition: all 0.5s ease-out;
            font-weight: bold;
            color: inherit; 
            margin-top: 5px;
        }

        /* --- æŒ‰éˆ•å€åŸŸ --- */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            font-size: 1rem; 
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: bold; transition: transform 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        button:hover { transform: translateY(-2px); }

        .btn-restart { background: #34495e; color: white; }
        .btn-study { background: #3498db; color: white; }
        .btn-rank { background: #f1c40f; color: #2c3e50; }

        /* --- å½ˆçª—é€šç”¨ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex; /* é è¨­é¡¯ç¤ºï¼Œç”± JS æ§åˆ¶ */
            justify-content: center; align-items: center;
            z-index: 1000;
            opacity: 1; transition: opacity 0.3s;
        }
        .modal-overlay.hidden { display: none; opacity: 0; }

        .modal-content {
            background: white;
            width: 90%; max-width: 500px;
            max-height: 85vh;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow-y: auto;
            position: relative;
            text-align: center;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;
        }
        .modal-title { font-size: 1.5rem; color: #333; font-weight: 800; }
        .close-btn { font-size: 2rem; cursor: pointer; color: #999; line-height: 1; }
        
        /* ç™»å…¥ä»‹é¢æ¨£å¼ */
        .login-box h2 { color: #2c3e50; margin-bottom: 10px; }
        .login-box p { color: #7f8c8d; margin-bottom: 20px; }
        .login-input {
            padding: 15px; width: 80%; font-size: 1.1rem; border: 2px solid #ddd;
            border-radius: 10px; margin-bottom: 15px; outline: none; text-align: center;
        }
        .login-input:focus { border-color: #3498db; }
        .btn-login { background: #3498db; color: white; width: 100%; margin-top: 10px; justify-content: center;}

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rank-table th { background: #f8f9fa; color: #7f8c8d; padding: 10px; font-size: 0.9rem; text-align: left; }
        .rank-table td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 1.1rem; text-align: left; }
        .rank-row:nth-child(1) .rank-num { color: #f1c40f; font-weight: 900; font-size: 1.3rem; }
        .rank-row:nth-child(2) .rank-num { color: #bdc3c7; font-weight: bold; }
        .rank-row:nth-child(3) .rank-num { color: #e67e22; font-weight: bold; }
        .rank-name { font-weight: bold; color: #2c3e50; }
        .rank-score { font-family: 'Courier New', monospace; font-weight: bold; color: #2980b9; text-align: right !important; }

        /* æº«ç¿’è¡¨æ¨£å¼ */
        .study-grid { display: grid; gap: 15px; text-align: left; }
        .study-group { border: 1px solid #eee; border-radius: 12px; padding: 15px; background: #fafafa; border-left: 5px solid #ccc; }
        .study-meaning { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 8px; }
        .study-words { display: flex; flex-wrap: wrap; gap: 8px; }
        .study-tag { background: white; padding: 6px 14px; border-radius: 20px; border: 1px solid #eee; font-size: 0.95rem; color: #555; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        
        /* --- å–®å­—é»æ“Šå‹•ç•« --- */
@keyframes pop-effect {
    0% { transform: scale(1); }
    50% { 
        transform: scale(1.25); /* ç¨å¾®æ”¾å¤§ä¸€é»é»ï¼Œé…åˆé•·ä¸€é»çš„æ™‚é–“ */
        background-color: #fff; 
        border-color: var(--pop-color); /* é‚Šæ¡†è®Šè‰² */
        box-shadow: 0 0 15px var(--pop-color); /* ç™¼å…‰è®Šè‰² */
    }
    100% { transform: scale(1); }
}

/* é€™å€‹ class æœƒç”± JS å‹•æ…‹åŠ å…¥ */
.pop-active {
    animation: pop-effect 0.6s ease-out; /* æ™‚é–“åŠ é•·è‡³ 0.6s */
}

        /* --- ğŸ” æœå°‹åŠŸèƒ½æ¨£å¼ (æ–°) --- */
        .search-trigger-icon {
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 15px; /* èˆ‡ X æŒ‰éˆ•ä¿æŒè·é›¢ */
            transition: transform 0.2s;
        }
        .search-trigger-icon:hover { transform: scale(1.2); }

        .search-bar-wrapper {
            max-height: 0; /* é è¨­éš±è— (é«˜åº¦ç‚º 0) */
            overflow: hidden;
            transition: max-height 0.3s ease-out; /* æ»‘å‹•å‹•ç•« */
            background: white;
            border-bottom: 1px solid #eee;
        }
        
        /* ç•¶æœå°‹æ¬„æ‰“é–‹æ™‚çš„ç‹€æ…‹ */
        .search-bar-wrapper.open {
            max-height: 70px; /* æ‰“é–‹çš„é«˜åº¦ */
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 50px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
            background-color: #f8f9fa;
            margin: 10px 0;
        }
        .search-input:focus {
            border-color: #3498db;
            background-color: #fff;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.2);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
        .shake { animation: shake 0.4s; }

        /* --- ğŸ”¥ æ–°å¢ï¼šå‘¼å¸ç‡ˆå‹•ç•« (Breathing Effect) --- */
        @keyframes breathing {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 68, 173, 0.4); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(142, 68, 173, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(142, 68, 173, 0.4); }
        }

        .breathing-btn {
            animation: breathing 2s infinite ease-in-out !important;
        }

        /* ç¢ºä¿ Result Modal çš„å…§å®¹æ•´é«”æ²å‹•ï¼Œè€Œä¸æ˜¯åˆ†é–‹æ²å‹• */
        .modal-content {
            overflow-y: auto; /* ç¢ºä¿æ•´å€‹å½ˆçª—å…§å®¹éƒ½å¯æ²å‹• */
        }
/* --- ğŸ”¥ æº«ç¿’è¡¨ UI ä¿®å¾© (å›ºå®š Header + å®Œç¾åœ“è§’) --- */

/* 1. ä¿®æ”¹å½ˆçª—å®¹å™¨ï¼šè®Šæˆ Flex ä½ˆå±€ï¼Œå¤–æ¡†è² è²¬åœ“è§’ï¼Œå…§éƒ¨è² è²¬æ²å‹• */
.modal-content {
    padding: 0 !important; /* ç§»é™¤å…§è·ï¼Œè®“ Header å¯ä»¥è²¼é‚Š */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* é—œéµï¼å°‡è¶…å‡ºçš„å…§å®¹(åŒ…æ‹¬ Scrollbar) éš±è—åœ¨åœ“è§’å…§ */
    max-height: 85vh;
    border-radius: 20px; /* ç¢ºä¿å››å€‹è§’éƒ½åœ“ */
}

/* 2. å›ºå®šæ¨™é ­å€ï¼šä¸æœƒéš¨å…§å®¹æ²å‹• */
.modal-header {
    padding: 20px 25px; /* è£œå› Padding */
    background: white;
    z-index: 10;
    flex-shrink: 0; /* ç¦æ­¢è¢«å£“ç¸® */
    border-bottom: 2px solid #f0f0f0;
}

/* 3. æœå°‹æ¬„å€åŸŸï¼šåŒæ¨£å›ºå®š */
.search-bar-wrapper {
    flex-shrink: 0;
    background: white;
    width: 100%;
}

/* 4. æç¤ºæ–‡å­— (é»æ“Šç™¼éŸ³)ï¼šåŒæ¨£å›ºå®š */
.study-hint-text {
    flex-shrink: 0;
    padding: 10px 25px 0 25px;
    margin: 0;
    color: #7f8c8d;
    background: white;
    font-size: 0.9rem;
}

/* 5. å…§å®¹åˆ—è¡¨å€ï¼šåªæœ‰é€™è£¡æ˜¯å¯æ²å‹•çš„ (Scrollable) */
.study-grid {
    overflow-y: auto; /* æ²å‹•æ¢åªåœ¨é€™è£¡å‡ºç¾ */
    padding: 20px 25px;
    flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
    scroll-behavior: smooth;
}

/* ç¾åŒ–æ²å‹•æ¢ (è®“å®ƒçœ‹èµ·ä¾†æ²’é‚£éº¼ç²—é­¯ï¼Œä¸æœƒç ´å£åœ“è§’æ„Ÿ) */
.study-grid::-webkit-scrollbar {
    width: 8px;
}
.study-grid::-webkit-scrollbar-track {
    background: transparent;
}
.study-grid::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: content-box;
}
/* --- ğŸ¤– AI åŠ©æ‰‹å°ˆç”¨æ¨£å¼ --- */
        .btn-ai-ask {
            background: #9b59b6; /* ç´«è‰² */
            color: white;
            border: none;
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            vertical-align: middle;
        }
        .btn-ai-ask:hover { background: #8e44ad; transform: translateY(-1px); }
        .btn-ai-ask:disabled { background: #ccc; cursor: wait; }

.ai-response-box {
    margin-top: 10px;
    padding: 15px;
    background-color: #f3e5f5;
    border-radius: 8px;
    border-left: 4px solid #9b59b6;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #2c3e50;
    
    display: none; /* é è¨­éš±è— */
    white-space: pre-wrap;
    text-align: left;
    
    /* âœ¨ æ”¹ç”¨æ–°å‹•ç•«ï¼šæ™‚é–“ 0.5ç§’ï¼Œä½¿ç”¨ ease-out ä»¤çµå°¾æ¸›é€Ÿ */
    animation: aiPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
    transform-origin: top center; /* è¨­å®šè®Šå½¢èµ·é»åœ¨é ‚éƒ¨ */
    overflow: hidden; /* ç¢ºä¿å±•é–‹æ™‚å…§å®¹å””æœƒæº¢å‡º */
    
    width: 100%;
    box-sizing: border-box;
}
        
        .ai-loading { color: #9b59b6; font-weight: bold; margin-top: 5px; display: none; }
        /* --- ğŸ¤– AI åŠ©æ‰‹å°ˆç”¨æ¨£å¼ (ä»¿ç…§æ—¥æ–‡Game) --- */
        .ai-btn {
            background: #9b59b6; /* ç´«è‰² */
            color: white;
            border: none;
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            vertical-align: middle;
        }
        .ai-btn:hover { background: #8e44ad; transform: translateY(-1px); }
        .ai-btn:disabled { background: #ccc; cursor: wait; }

        /* ç´«è‰²å›æ‡‰æ¡† */
.ai-response-box {
    margin-top: 10px;
    padding: 15px;
    background-color: #f3e5f5;
    border-radius: 8px;
    border-left: 4px solid #9b59b6;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #2c3e50;
    
    display: none; /* é è¨­éš±è— */
    white-space: pre-wrap;
    text-align: left;
    
    /* âœ¨ æ”¹ç”¨æ–°å‹•ç•«ï¼šæ™‚é–“ 0.5ç§’ï¼Œä½¿ç”¨ ease-out ä»¤çµå°¾æ¸›é€Ÿ */
    animation: aiPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
    transform-origin: top center; /* è¨­å®šè®Šå½¢èµ·é»åœ¨é ‚éƒ¨ */
    overflow: hidden; /* ç¢ºä¿å±•é–‹æ™‚å…§å®¹å””æœƒæº¢å‡º */
    
    width: 100%;
    box-sizing: border-box;
}

        /* ç°¡å–®çš„ Markdown æ¨™é¡Œæ¨£å¼ */
        .ai-response-box h4 {
            margin: 15px 0 5px;
            color: #8e44ad;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
        }
        @keyframes aiPopIn {
    0% {
        opacity: 0;
        transform: translateY(-10px) scale(0.95); /* åˆå§‹ï¼šå‘ä¸Šç¸®å°‘å°‘ + ç¸®ç´° */
        max-height: 0; /* é«˜åº¦ç”± 0 é–‹å§‹ */
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
    }
    60% {
        opacity: 1;
        transform: translateY(2px) scale(1.01); /* ä¸­é€”ï¼šè¼•å¾®éç•Œ (å½ˆæ€§æ•ˆæœ) */
        max-height: 500px; /* å¿«é€Ÿæ‹‰é–‹é«˜åº¦ */
        padding-top: 15px;
        padding-bottom: 15px;
        margin-top: 10px;
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1); /* çµå°¾ï¼šå›å¾©æ­£å¸¸ */
        max-height: 1000px; /* ç¢ºä¿å¤ ä½é¡¯ç¤º */
    }
}
    </style>
</head>
<body>

    <h1>ğŸ‘»åŒç¾©è©ã®é¬¼ğŸ‘»</h1>
    <p>Presented by Enguistics Learning Centre</p>
    <p>å¦‚ç”¨AI, è«‹é€£VPN</p>
        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <div class="info-panel">
        <div class="user-panel" id="userPanel" style="display:none;">
            ğŸ‘¤ <span id="currentUserDisplay">Player</span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
        <div class="stat-box">LEVEL <span id="level-display">1</span></div>
        <div class="stat-box">â±ï¸ <span id="timer">100</span>s</div>
        <div class="stat-box"> <span id="lives">10</span></div> 
        <div class="stat-box score-box">ğŸ† Score: <span id="total-score">0</span></div>
    </div>

    <div id="startOverlay" style="text-align: center; margin: 20px 0;">
        <h2 style="color: #2c3e50; margin-bottom: 15px;">æº–å‚™å¥½æ¥å—æŒ‘æˆ°äº†å—ï¼Ÿ</h2>
        <button onclick="startGameSession()" style="background: #e74c3c; color: white; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; border:none; cursor:pointer; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); font-weight:bold;">
            â–¶ é–‹å§‹éŠæˆ² (Start Game)
        </button>
    </div>

    <div class="game-grid" id="gameGrid"></div>

    <div class="action-buttons">
        <div id="preGameButtons" style="display: flex; gap: 15px;">
            <button class="btn-study" onclick="openStudyModal()">ğŸ“– æº«ç¿’è¡¨</button>
            <button class="btn-rank" onclick="openRankModal()">ğŸ‘‘ æ’è¡Œæ¦œ</button>
        </div>
        
        <div id="inGameButtons" style="display: none; gap: 15px;">
            <button class="btn-restart" id="btn-giveup" onclick="onGiveUp()">ğŸ³ï¸ æ”¾æ£„ & å›ä¸»é¸å–®</button>
            <button class="btn-study" id="btn-review-level" onclick="goToResultPage()" style="display:none; background: #8e44ad; color: white;">
                ğŸ“Š é—œå¡è©èªå›é¡§ (Review)
            </button>
        </div>
    </div>

<div class="modal-overlay hidden" id="resultModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ“Š æˆ°ç¸¾å ±å‘Š (Game Recap)</div>
                <div class="close-btn" onclick="closeResultAndReset()">&times;</div>
            </div>
            
            <div id="resultListContainer" style="text-align: left; padding: 20px 25px; overflow-y: auto; flex: 1;">
                </div>

            <div style="padding: 20px; background: #fff; border-top: 1px solid #eee; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-study" onclick="startGameSession()" style="width: 100%; justify-content: center; background: #27ae60; font-size: 1.1rem;">
                    ğŸ’ª å†ä¾†ä¸€å±€ (Play Again)
                </button>

                <div style="display: flex; gap: 10px;">
                    <button class="btn-rank" onclick="openRankModal()" style="flex: 1; justify-content: center;">
                        ğŸ‘‘ æ’è¡Œæ¦œ
                    </button>
                    <button class="btn-restart" onclick="closeResultAndReset()" style="flex: 1; justify-content: center; background: #95a5a6;">
                        ğŸ  ä¸»é¸å–®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-content login-box">
            <h2>ğŸ‘» æº–å‚™å¥½åšåŒç¾©è©ã®é¬¼äº†å—ï¼ŸğŸ‘»</h2>
            <p>è«‹è¼¸å…¥ä½ çš„åå­—ä»¥é–‹å§‹éŠæˆ²<br>(å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œç³»çµ±æœƒè‡ªå‹•è¨»å†Š)</p>
            <input type="text" id="loginNameInput" class="login-input" placeholder="ä¾‹å¦‚: Tom A" maxlength="12">
            <button class="btn-login" onclick="handleLogin()">é–‹å§‹éŠæˆ² (Start)</button>
            <p style="font-size: 0.8rem; margin-top: 15px; color: #95a5a6;">*è«‹ä½¿ç”¨ç¨ç‰¹çš„åå­—ï¼Œä¸èƒ½èˆ‡ä»–äººé‡è¤‡</p>
        </div>
    </div>

<div class="modal-overlay hidden" id="rankModal">
        <div class="modal-content">
            
            <div class="modal-header" style="justify-content: center; position: relative;">
                <div class="modal-title">ğŸ‘»æœ€å¼·åŒç¾©è©ã®é¬¼ğŸ‘»</div>
                <div class="close-btn" onclick="closeModal('rankModal')" style="position: absolute; right: 20px;">&times;</div>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px;">
                
                <div id="loadingRank">è¼‰å…¥ä¸­...</div>
                
                <table class="rank-table" id="rankTable">
                    <thead>
                        <tr>
                            <th width="15%">#</th>
                            <th>Player</th>
                            <th style="text-align: right;">æˆ°é¬¥åŠ›</th>
                        </tr>
                    </thead>
                    <tbody id="rankListBody"></tbody>
                </table>

            </div>
        </div>
    </div>
<div class="modal-overlay hidden" id="studyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display: flex; align-items: center;">
                    <div class="modal-title">Reading å¸¸è€ƒåŒç¾©å­—</div>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="search-trigger-icon" onclick="toggleSearchBar()">ğŸ”</div>
                    <div class="close-btn" onclick="closeModal('studyModal')">&times;</div>
                </div>
            </div>
            
            <div class="search-bar-wrapper" id="searchBarWrapper">
                <div style="padding: 0 25px;"> <input type="text" id="studySearchInput" class="search-input" placeholder="è¼¸å…¥é—œéµå­— (ä¾‹å¦‚: sufficient)...">
                </div>
            </div>

            <p class="study-hint-text">(é»æ“Šå–®å­—å¯ç™¼éŸ³ ğŸ”Š)</p>

            <div class="study-grid" id="studyListContainer"></div>
        </div>
    </div>

<script>
        // --- 1. Firebase è¨­å®šèˆ‡åˆå§‹åŒ– ---
    // ------------------------------------------------------------------
        // ğŸ¤– Google Gemini AI è¨­å®š (åƒç…§ index 3 çš„åˆ†æ‹†å¯«æ³•)
        // ------------------------------------------------------------------
        const keyPart1 = "AIzaSy";
        const keyPart2 = "AGTEyUJgidRSYbn1kVXR5NgMbuvAmPuQc"; 
        const GEMINI_API_KEY = keyPart1 + keyPart2;

        async function askGemini(btn, meaning, wordsArray) {
            // 1. æ‰¾å‡ºæŒ‰éˆ•æ‰€åœ¨çš„å®¹å™¨ (æº«ç¿’è¡¨ æˆ– æˆç¸¾è¡¨)
            const parentContainer = btn.closest('.study-group') || btn.closest('.result-group-box');
            
            // 2. æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å›æ‡‰æ¡†
            let responseBox = parentContainer.querySelector('.ai-response-box');
            
            // å¦‚æœé‚„æ²’å»ºç«‹ï¼Œå°±å³å ´å»ºç«‹ä¸€å€‹ div
            if (!responseBox) {
                responseBox = document.createElement('div');
                responseBox.className = 'ai-response-box';
                parentContainer.appendChild(responseBox); // åŠ åœ¨è©²å€åŸŸçš„æœ€å¾Œé¢
            }

            // 3. Toggle åŠŸèƒ½ï¼šå¦‚æœå·²ç¶“æ‰“é–‹ä¸”ä¸æ˜¯è¼‰å…¥ä¸­ï¼Œå°±é—œé–‰å®ƒ
            if (responseBox.style.display === 'block' && !btn.disabled) {
                responseBox.style.display = 'none';
                return;
            }

            // 4. UI ç‹€æ…‹ï¼šè¼‰å…¥ä¸­
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ¤– æ€è€ƒä¸­...';
            responseBox.style.display = 'block';
            responseBox.innerHTML = 'Preparing for another level shit';

            // 5. æº–å‚™è³‡æ–™
            const wordsList = wordsArray.map(w => (typeof w === 'string' ? w : w.t)).join(', ');

            // 6. è¨­å®š Prompt (æŒ‡ä»¤) - é‡å°åŒç¾©è©è¨­è¨ˆ
const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è‹±æ–‡è£œç¿’åå¸« ã€‚
                é€™çµ„åŒç¾©è©çš„æ„æ€æ˜¯ï¼šã€Œ${meaning}ã€ã€‚
                å–®å­—åˆ—è¡¨ï¼š[ ${wordsList} ]

                è«‹ç”¨ **å»£æ±è©±** åˆ†æã€‚
                
                **åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š**
                1. **ä¸è¦**æœ‰ä»»ä½•é–‹å ´ç™½ (ä¾‹å¦‚ Helloã€ä»Šæ—¥è¬›ä¹œä¹œ)ï¼Œç›´æ¥ç”±ç¬¬ä¸€å€‹å–®å­—æ¨™é¡Œé–‹å§‹ã€‚
                2. **ä¸è¦**æœ‰ä»»ä½•çµèªã€ç¸½çµæˆ–é¼“å‹µèªªè©±ã€‚
                3. **ä¸­æ–‡å®šç¾©èˆ‡èªå¢ƒ** å¿…é ˆ **æ¥µåº¦ç°¡æ½”**ï¼Œç›´æ¥è¬›é‡é» (ä¾‹å¦‚ï¼šè¤’ç¾©/è²¶ç¾©ã€æ­£å¼/å£èªã€ç¨ç‰¹ç”¨æ³•)ï¼Œä¸è¦é•·ç¯‡å¤§è«–ã€‚

                è«‹é‡å°åˆ—è¡¨ä¸­çš„ **æ¯ä¸€å€‹å–®å­—**ï¼Œä¾ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š
                
                ### [å–®å­—]
                * **ç°¡æ½”å®šç¾©**ï¼š(ç²¾æº–é»å‡º**HKDSEå¯«ä½œæ™‚ä½¿ç”¨çš„è¦é»/é©ç”¨æ–‡é«”**)
                * **ä¾‹å¥**ï¼š(**å…©å¥å’ŒHKDSEæœ‰é—œçš„ä½œæ–‡è‹±æ–‡ä¾‹å¥ + ä¸­æ–‡ç¿»è­¯**)
                * **å¸¸ç”¨æ­é…**ï¼š(**æ¯å­—åˆ—å‡º 2-3 å€‹ç”¨åˆ°çš„HKDSEå¯«ä½œé…æ­**)
            `;
            // 7. Call Gemini API
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                // 8. è™•ç†å›å‚³æ–‡å­— (ç°¡å–® Markdown è½‰ HTML)
                let aiText = data.candidates[0].content.parts[0].text;
                
                // æ ¼å¼åŒ–ï¼šå°‡ ### æ¨™é¡Œè½‰ç‚º h4ï¼Œ**æ–‡å­—** è½‰ç‚ºç²—é«”
                aiText = aiText.replace(/### (.*?)\n/g, '<h4>$1</h4>');
                aiText = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                aiText = aiText.replace(/^\* /gm, 'â€¢ '); //å°‡åˆ—è¡¨ç¬¦è™Ÿè½‰ç‚ºé»
                
                // é¡¯ç¤ºçµæœ
                responseBox.innerHTML = aiText;

            } catch (error) {
                console.error(error);
                responseBox.innerHTML = `<span style="color:red;">âŒ AI é€£ç·šå¤±æ•—: ${error.message}</span>`;
            } finally {
                // æ¢å¾©æŒ‰éˆ•
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        const firebaseConfig = {
            apiKey: "AIzaSyBdfTgb7FpkYdgjvrYWQ0jr-N-1fAaW9Q0",
            authDomain: "vocabularyxdungeon.firebaseapp.com",
            databaseURL: "https://vocabularyxdungeon-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "vocabularyxdungeon",
            storageBucket: "vocabularyxdungeon.appspot.com",
            messagingSenderId: "834761939928",
            appId: "1:834761939928:web:d0fde740639a3eca46f0ad"
        };
        
        let db = null;
        let currentPlayer = null; 
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (e) {
            alert("âŒ Firebase åˆå§‹åŒ–å¤±æ•—ï¼\néŒ¯èª¤: " + e.message);
        }

        const LEADERBOARD_PATH = 'leaderboards/synonym_hunter';
        const USERS_PATH = 'users'; 

        // --- 2. æ•¸æ“šåº« ---
        const synonymData = [
            { id: 'sufficient', color: 'lime', meaning: 'å……è¶³ / è¶³å¤ ', words: [{ t: 'Sufficient', m: 'è¶³å¤ ' }, { t: 'Adequate', m: 'è¶³å¤ ' }, { t: 'Ample', m: 'å……è¶³' }, { t: 'Abundant', m: 'å……è¶³' }, { t: 'plentiful', m: 'å……è¶³' }] },
            { id: 'shocking', color: 'red', meaning: 'ä»¤äººéœ‡é©š', words: ['Shocking', 'Astonishing', 'Astounding', 'Mind-blowing', 'Mind-boggling', 'Jaw-dropping', 'Striking'] },
            { id: 'means', color: 'blueviolet', meaning: 'æ–¹æ³•', words: ['Way', 'Method', 'Means', 'Approach'] },
            { id: 'resemble', color: 'gray', meaning: 'ç›¸ä¼¼', words: [{ t: 'Similar to', m: 'ç›¸ä¼¼(æ³›ç”¨)' }, { t: 'Akin to', m: 'ç›¸ä¼¼(æŠ½è±¡)' }, { t: 'Resemble', m: 'ç›¸ä¼¼(ç‰©ç†)' }, { t: 'Alike', m: 'å¥½ç›¸ä¼¼(æ”¾å¥å°¾)' }] },
            { id: 'strange', color: 'mediumorchid', meaning: 'å¥‡æ€ª', words: ['Strange', 'Odd', 'Weird', 'Bizarre', 'Eerie', 'Peculiar', 'Eccentric'] },
            { id: 'hamper', color: 'maroon', meaning: 'å¦¨ç¤™', words: ['Hamper', 'Hinder', 'Obstruct', 'Impede'] },
            { id: 'however', color: 'brown', meaning: 'ä½†æ˜¯/ç„¶è€Œ', words: ['However', 'Yet', 'Nevertheless', 'Nonetheless'] },
            { id: 'be that as it may', color: 'burlywood', meaning: 'è©±é›–å¦‚æ­¤', words: ['Be that as it may', 'That said', 'Having said that', 'With that said'] },
            { id: 'especially', color: 'burlywood', meaning: 'å°¤å…¶æ˜¯', words: ['Especially', 'Particularly', 'In particular'] },
            { id: 'specific', color: 'coral', meaning: 'ç‰¹å®š', words: ['Specific', 'Particular'] },
            { id: 'benefit', color: 'cadetblue', meaning: 'å¥½è™•', words: [{ t: 'Benefit', m: 'ç›Šè™•' }, { t: 'Merit', m: 'å„ªé»' }, { t: 'Pros', m: 'åˆ©(å¿…é ˆçœ¾æ•¸)' }, { t: 'Advantage', m: 'å„ªé»' }] },
            { id: 'drawback', color: 'chocolate', meaning: 'å£è™•', words: [{ t: 'Drawback', m: 'å¼Šè™•' }, { t: 'Demerit', m: 'ç¼ºé»' }, { t: 'Cons', m: 'å¼Š(å¿…é ˆçœ¾æ•¸)' }, { t: 'Disadvantage', m: 'ç¼ºé»' }] },
            { id: 'foster', color: 'green', meaning: 'ä¿ƒé€²', words: [{ t: 'Foster', m: 'ä¿ƒé€²' }, { t: 'Facilitate', m: 'ä¿ƒé€²' }, { t: 'Promote', m: 'ä¿ƒé€²' }] },
            { id: 'decrease', color: 'olive', meaning: 'æ¸›å°‘', words: [{ t: 'Decrease', m: 'æ¸›å°‘' }, { t: 'Dwindle', m: 'æ¸›å°‘' }, { t: 'Plunge', m: 'æ€¥è·Œ' }, { t: 'Slump', m: 'æ€¥è·Œ' }, { t: 'Sink', m: 'æ€¥è·Œ' }, { t: 'Decline', m: 'ä¸‹é™' },{ t: 'Plummet', m: 'æ€¥è·Œ' }, { t: 'Reduce ', m: 'æ¸›å°‘(+n)' }, { t: 'Lower ', m: 'æ¸›å°‘(+n)' }, { t: 'minimise ', m: 'æ¸›å°‘(+n)' }] },
            { id: 'staggering', color: 'yellow', meaning: 'å¤§(æ•¸å­—)', words: [{ t: 'Staggering', m: 'å¤§(æ•¸å­—)' }, { t: 'Whopping', m: 'å¤§(æ•¸å­—)' }] },
            { id: 'important', color: 'blue', meaning: 'é‡è¦', words: [{ t: 'Crucial', m: 'æ¥µé‡è¦' }, { t: 'Significant', m: 'é‡è¦' }, { t: 'Vital', m: 'å¿…ä¸å¯å°‘' }, { t: 'Indispensable', m: 'ä¸å¯æˆ–ç¼º' }, { t: 'Key', m: 'é—œéµæ€§çš„' }, { t: 'Critical', m: 'é—œéµæ€§çš„' }] },
            { id: 'Cultivate', color: 'lime', meaning: 'åŸ¹è‚²', words: [{ t: 'Cultivate', m: 'åŸ¹é¤Š' }, { t: 'Nurture', m: 'å­•è‚²' }] },
            { id: 'instead of', color: 'purple', meaning: 'è€Œä¸æ˜¯', words: ['Instead of', 'Rather than', 'As opposed to'] }, // 
            { id: 'suffer from', color: 'fuchsia', meaning: 'æ‚£ä¸Š', words: ['Suffer from', 'Develop', 'Afflicted with'] }, 
            { id: 'enormous', color: 'navy', meaning: 'å·¨å¤§çš„', words: ['Enormous', 'Immense', 'Massive', 'Tremendous'] },
            { id: 'situation', color: 'teal', meaning: 'æƒ…æ³', words: ['Situation', 'Condition', 'Circumstances', 'Scenario'] },
            { id: 'Amend', color: 'coral', meaning: 'ç›¸ä¼¼', words: [{ t: 'Amend', m: 'ä¿®æ”¹(æ–‡ä»¶)' }, { t: 'Modify', m: 'èª¿æ•´' }, { t: 'Adjust ', m: 'èª¿ç¯€' }, { t: 'Tune', m: 'å¾®èª¿(å·¥å…·)' }] },
            { id: 'tackle', color: 'cornflowerblue', meaning: 'æ‡‰è©²/è™•ç†', words: ['Handle', 'Tackle', 'Deal with', 'Cope with', 'Address'] },
            { id: 'unprecedented', color: '#e67e22', meaning: 'å‰æ‰€æœªæœ‰', words: ['More than ever', 'Unprecedented'] },
            { id: 'proliferate', color: 'aquamarine', meaning: 'æ¿€å¢',words: [{ t: 'Soar', m: 'æ€¥å‡' }, { t: 'Skyrocket', m: 'é£›æ¼²' }, { t: 'Proliferate', m: 'æ¿€å¢' }, { t: 'Mushroom', m: 'å¤§é‡å¢åŠ ' }, { t: 'spring up', m: 'æ¹§ç¾' }, { t: 'sprout', m: 'æ¹§ç¾(å¼·èª¿æ–°å‡ºç¾)' }, { t: 'Shoot up', m: 'æ€¥é€Ÿå¢åŠ ' }] },

            { id: 'Deteriorate', color: 'darkblue', meaning: 'æƒ¡åŒ–', words: [{ t: 'Deteriorate', m: 'æƒ¡åŒ–(ä¸+n)' }, { t: 'Aggravate', m: 'æƒ¡åŒ–(+n)' }, { t: 'Exacerbate', m: 'æƒ¡åŒ–(+n)' }, { t: 'Worsen ', m: 'æƒ¡åŒ–(+n/ä¸+n)' }] },
{ 
                id: 'extraordinary', color: '#e74c3c', meaning: 'å‡ºçœ¾ / å‚‘å‡º', 
                words: ['Extraordinary', 'Exceptional', 'Outstanding', 'Remarkable'] 
            },
            { 
                id: 'headwind', color: '#8e44ad', meaning: 'é›£é—œ / é€†å¢ƒ', 
                words: [{t:'Headwind', m:'é›£é—œ(é€†å¢ƒ)'}, {t:'Uphill battle', m:'é›£é—œ(ç¡¬ä»—)'}, {t:'Obstacle', m:'éšœç¤™'}] 
            },
            { 
                id: 'harness', color: '#2980b9', meaning: 'é§•é¦­ / æ§åˆ¶', 
                words: ['Harness', 'Manipulate', 'Control', 'Utilize'] 
            },
            { 
                id: 'spur', color: '#27ae60', meaning: 'åˆºæ¿€ / æ¿€å‹µ', 
                words: ['Spur', 'Stimulate', 'Prompt', 'Propel'] 
            },
            { 
                id: 'exponential', color: '#d35400', meaning: 'å·¨å¤§çš„ / æ€¥åŠ‡çš„', 
                words: ['Exponential', 'Drastic', 'Significant', 'Tremendous'] 
            },
            { 
                id: 'pressing', color: '#c0392b', meaning: 'è¿«åœ¨çœ‰ç«', 
                words: ['Pressing', 'Looming', 'Imminent', 'Urgent'] 
            },
            { 
                id: 'fulfil', color: '#16a085', meaning: 'æ»¿è¶³', 
                words: ['Fulfil', 'Satisfy'] 
            },
                        { 
                id: 'meet', color: '#46a085', meaning: 'é”åˆ°', 
                words: ['Meet', 'Come up to'] 
            },
            { 
                id: 'strategy', color: '#2c3e50', meaning: 'ç­–ç•¥', 
                words: [{t:'Strategy', m:'æˆ°ç•¥(é•·é )'}, {t:'Tactic', m:'æˆ°è¡“(çŸ­æœŸ)'}] 
            },
            { 
                id: 'grasp', color: '#e67e22', meaning: 'æŠ“ç·Š / æŠŠæ¡', 
                words: ['Grasp', 'Seize', 'Grab'] 
            },
            { 
                id: 'operate', color: '#34495e', meaning: 'ç¶“ç‡Ÿ / é‹ä½œ', 
                words: ['Operate', 'Run'] 
            },
            { 
                id: 'drive', color: '#2980b9', meaning: 'é©…ä½¿', 
                words: ['Drive', 'Prompt'] 
            },
            { 
                id: 'convert', color: '#27ae60', meaning: 'è½‰è®Šç‚º', 
                words: ['Convert into', 'Transform into', 'Turn into'] 
            },
                        { 
                id: 'the same', color: '#8c0ff1 ', meaning: 'ä¸€æ¨¡ä¸€æ¨£', 
                words: ['Homogeneous', 'The same', 'Identical'] 
            },
            { 
                id: 'transmit', color: '#1abc9c', meaning: 'å‚³é / å‚³æ’­', 
                words: [
                    {t:'Transmit', m:'å‚³é(è¨Šè™Ÿ)'}, 
                    {t:'Deliver', m:'å‚³é(è²¨ç‰©)'}, 
                    {t:'Convey', m:'å‚³é”(æ„æ€)'}, 
                    {t:'Impart', m:'åˆ†äº«(çŸ¥è­˜)'}, 
                    {t:'Spread', m:'å‚³æ’­'}
                ] 
            },
            { 
                id: 'collective', color: '#9b59b6', meaning: 'å…±åŒçš„', 
                words: ['Collective', 'Concerted', 'Joint'] 
            },
            { 
                id: 'limit', color: '#c0392b', meaning: 'é™åˆ¶', 
                words: ['Limit', 'Constrain', 'Restrict', 'Confine'] 
            },
            { 
                id: 'change', color: '#f39c12', meaning: 'æ”¹è®Š (ç¨‹åº¦)', 
                words: [
                    {t:'Transform', m:'æ”¹è®Š(å¤§)'}, 
                    {t:'Evolve', m:'é€²åŒ–(ç§‘æŠ€)'}, 
                    {t:'Advance', m:'é€²æ­¥(ç§‘æŠ€)'}, 
                    {t:'Alter', m:'æ”¹è®Š(å°)'}, 
                    {t:'Shift', m:'è½‰è®Š/è½‰ç§»'}
                ] 
            },
            { 
                id: 'meanwhile', color: '#7f8c8d', meaning: 'èˆ‡æ­¤åŒæ™‚', 
                words: ['Meanwhile', 'In the meantime', 'At the same time'] 
            },
            { 
                id: 'implication', color: '#34495e', meaning: 'æš—ç¤º / å½±éŸ¿', 
                words: ['Implication', 'Suggestion', 'Insinuation', 'Consequence'] 
            },
            { 
                id: 'prosper', color: '#c40ff1', meaning: 'è‡´å‘½çš„', 
                words: ['Lethal', 'Fatal', 'Deadly'] 
            },
                        { 
                id: 'thrive', color: '#d40ff1', meaning: 'ç¹ç››', 
                words: ['Thrive', 'Flourish', 'Prosper'] 
            },
            { 
                id: 'boom', color: '#f1c40f', meaning: 'å¿«é€Ÿç™¼å±•', 
                words: ['Boom', 'Burgeon'] 
            },
                    { 
                id: 'act as', color: '#b1c40f', meaning: 'ä½œç‚º', 
                words: ['Act as', 'Serve as'] 
            },
                                { 
                id: 'firm', color: '#0f74f1', meaning: 'å…¬å¸/æ©Ÿæ§‹', 
                words: [
                    {t:'Company', m:'å…¬å¸'}, 
                    {t:'Firm', m:'å…¬å¸(å°ˆæ¥­)'}, 
                    {t:'Enterprise', m:'ä¼æ¥­'}, 
                    {t:'Agency', m:'ä¸­ä»‹å…¬å¸'}, 
                    {t:'Corporation', m:'å¤§ä¼æ¥­'},
                    {t:'Establishment', m:'æ©Ÿæ§‹'},
                    {t:'Institute', m:'æ©Ÿæ§‹'},
                    {t:'Institution', m:'æ©Ÿæ§‹'},
                ] 
            },
                               { 
                id: 'as if', color: '#0fe5f1', meaning: 'å½·å½¿', 
                words: ['as if', 'as though'] 
            },
            { 
                id: 'alternative', color: '#16a085', meaning: 'å¦ä¸€é¸æ“‡', 
                words: ['Alternative', 'Substitute'] 
            },
            { 
                id: 'beyond', color: '#8e44ad', meaning: 'ä¸å–®åª / è¶…è¶Š', 
                words: ['Beyond', 'More than', 'Other than', 'On top of'] 
            },
            { 
                id: 'emerge', color: '#e67e22', meaning: 'å‡ºç¾', 
                words: [
                    {t:'Emerge', m:'å‡ºç¾'}, 
                    {t:'Appear', m:'å‡ºç¾'}, 
                    {t:'Arise', m:'å‡ºç¾'}, 
                    {t:'Surface', m:'æµ®ç¾'}
                ] 
            },
            { 
                id: 'undermine', color: '#c0392b', meaning: 'ç ´å£ / æå®³', 
                words: [
                    {t:'Undermine', m:'ç ´å£(æš—ä¸­/æ…¢)'}, 
                    {t:'Take a toll on', m:'é€ æˆæå¤±(æ³›ç”¨)'}, 
                    {t:'Deal a blow to', m:'æ‰“æ“Š(çªç„¶)'}, 
                    {t:'Wreak havoc on', m:'æµ©åŠ«(å¤§ç ´å£)'}, 
                    {t:'Damage', m:'æå®³'}
                ] 
            },
            { 
                id: 'essential', color: '#2ecc71', meaning: 'å¿…è¦ / å¼·åˆ¶', 
                words: [
                    {t:'Essential', m:'å¿…è¦'}, 
                    {t:'Necessary', m:'å¿…è¦'}, 
                    {t:'Compulsory', m:'å¼·åˆ¶'}
                ] 
            },
            { 
                id: 'approx', color: '#bdc3c7', meaning: 'å¤§ç´„ / å¹¾ä¹', 
                words: ['Roughly', 'Approximately', 'Almost', 'Around'] 
            },
            { 
                id: 'mitigate', color: '#3498db', meaning: 'èˆ’ç·© / æ¸›è¼•', 
                words: ['Mitigate', 'Relieve', 'Alleviate', 'Ease', 'Allay'] 
            },
            { 
                id: 'achieve', color: '#f39c12', meaning: 'é”æˆ', 
                words: ['Achieve', 'Attain', 'Accomplish'] 
            },
            { 
                id: 'accusation', color: '#e74c3c', meaning: 'æŒ‡æ§ / èµ·è¨´', 
                words: [
                    {t:'Accusation', m:'æŒ‡æ§'}, 
                    {t:'Prosecution', m:'æª¢æ§'}, 
                    {t:'Charge', m:'èµ·è¨´'}
                ] 
            },
                        { 
                id: 'disastrous', color: '#f18c0f', meaning: 'ç½é›£çš„', 
                words: [
                    {t:'Disastrous', m:'ç½é›£æ€§çš„'}, 
                    {t:'Catastrophic', m:'æ¥µç½é›£æ€§çš„'}, 
                    {t:'Devastating', m:'æ¯€æ»…æ€§çš„'}
                ] 
            },
            { 
                id: 'similarly', color: '#9b59b6', meaning: 'åŒæ¨£åœ°', 
                words: ['Similarly', 'Likewise'] 
            },
            { 
                id: 'appealing', color: '#e91e63', meaning: 'å¸å¼•çš„', 
                words: ['Appealing', 'Captivating', 'Attractive', 'Engaging'] 
            },
            { 
                id: 'wise', color: '#1abc9c', meaning: 'è°æ˜ / æ˜æ™º', 
                words: ['Wise', 'Intelligent', 'Witty'] 
            },
            { 
                id: 'customer', color: '#34495e', meaning: 'é¡§å®¢ / å®¢æˆ¶', 
                words: [
                    {t:'Customer', m:'é¡§å®¢'}, 
                    {t:'Client', m:'å®¢æˆ¶(å°ˆæ¥­)'}, 
                    {t:'Consumer', m:'æ¶ˆè²»è€…'}, 
                    {t:'Patron', m:'å¸¸å®¢/è´ŠåŠ©äºº'},
                    {t:'Frequenter', m:'å¸¸å®¢'}
                ] 
            },
            { 
                id: 'affordable', color: '#27ae60', meaning: 'å¯è² æ“” / å¯¦æƒ ', 
                words: ['Affordable', 'Economical', 'Budget-friendly'] 
            },
            { 
                id: 'worthwhile', color: '#f39c12', meaning: 'å€¼å¾—', 
                words: ['Worthwhile', 'Worthy'] 
            },
            { 
                id: 'struggle', color: '#c0392b', meaning: 'é›£ä»¥ / æ™æ‰', 
                words: ['Struggle to', 'Find it difficult', 'Have trouble'] 
            },
{ 
                id: 'vulnerable', 
                color: '#e74c3c', // Red
                meaning: 'æ˜“å—...å‚·å®³', 
                words: [
                    { t: 'Vulnerable to', m: 'æ˜“å—å‚·å®³' },
                    { t: 'Susceptible to', m: 'æ˜“å—å½±éŸ¿' },
                    { t: 'Prone to', m: 'å‚¾å‘æ–¼(è² é¢)' }
                ] 
            },
            // --- Group 2: éˆä¸¹å¦™è—¥ ---
            { 
                id: 'elixir', 
                color: '#f1c40f', // Gold
                meaning: 'éˆä¸¹å¦™è—¥', 
                words: ['Elixir', 'Panacea'] 
            },
            // --- Group 3: æ„›å¥½è€… ---
            { 
                id: 'fan', 
                color: '#e67e22', // Orange
                meaning: 'ç†±æ„›è€…', 
                words: [
                    { t: 'Fan', m: 'ç²‰çµ²' },
                    { t: 'Enthusiast', m: 'ç™¼ç‡’å‹' },
                    { t: 'Fanatic', m: 'ç‹‚ç†±è€…' }
                ] 
            },
            // --- Group 4: å¤§ç´„ ---
            { 
                id: 'approx', 
                color: '#95a5a6', // Gray
                meaning: 'å¤§ç´„', 
                words: ['Approximately', 'Roughly', 'Around', 'About'] 
            },
            // --- Group 5: å¹¾ä¹ ---
            { 
                id: 'almost', 
                color: '#7f8c8d', // Dark Gray
                meaning: 'å¹¾ä¹', 
                words: [
                    { t: 'Almost', m: 'å¹¾ä¹' },
                    { t: 'Virtually', m: 'å¹¾ä¹/äº‹å¯¦ä¸Š' }
                ] 
            },
            // --- Group 6: è¶³å¤  (åŸºæœ¬) ---
            { 
                id: 'enough', 
                color: '#2ecc71', // Emerald
                meaning: 'è¶³å¤ ', 
                words: ['Enough', 'Sufficient', 'Adequate'] 
            },
            // --- Group 7: å……è¶³ (è±å¯Œ) ---
            { 
                id: 'plenty', 
                color: '#27ae60', // Green
                meaning: 'å……è¶³ / è±å¯Œ', 
                words: [
                    { t: 'Plenty', m: 'å¤§é‡' },
                    { t: 'Plentiful', m: 'å……è¶³' },
                    { t: 'Ample', m: 'å……è£•' },
                    { t: 'Abundant', m: 'è±å¯Œ' }
                ] 
            },
            // --- Group 8: é è¨ˆ ---
            { 
                id: 'expect', 
                color: '#3498db', // Blue
                meaning: 'é è¨ˆ / é æ¸¬', 
                words: [
                    { t: 'Expect', m: 'é æœŸ' },
                    { t: 'Predict', m: 'é æ¸¬' },
                    { t: 'Anticipate', m: 'é æ–™' },
                    { t: 'Project', m: 'æ¨ç®—' },
                    { t: 'Foresee', m: 'é è¦‹' }
                ] 
            },
            // --- Group 9: å¤§å¹…åº¦ ---
            { 
                id: 'significant', 
                color: '#c0392b', // Dark Red
                meaning: 'å¤§å¹…åº¦ / é¡¯è‘—', 
                words: [
                    { t: 'Significant', m: 'é¡¯è‘—' },
                    { t: 'Substantial', m: 'å¯è§€çš„' },
                    { t: 'Drastic', m: 'æ¿€çƒˆçš„' },
                    { t: 'Radical', m: 'å¾¹åº•çš„' },
                    { t: 'Remarkable', m: 'éå‡¡çš„' }
                ] 
            },
            // --- Group 10: åè€Œ/ç›¸å ---
            { 
                id: 'instead', 
                color: 'darkgoldenrod', 
                meaning: 'åè€Œ / ç›¸å', 
                words: [
                    { t: 'Instead', m: 'ä½œç‚ºæ›¿ä»£' },
                    { t: 'Rather', m: 'åè€Œ' },
                    { t: 'In contrast', m: 'ç›¸æ¯”ä¹‹ä¸‹' },
                    { t: 'On the contrary', m: 'æ­£æ­£ç›¸å' }
                ] 
            },
            // --- Group 11: èˆ‡...æœ‰é—œ ---
            { 
                id: 'related', 
                color: 'darkcyan',
                meaning: 'èˆ‡...æœ‰é—œ', 
                words: [
                    { t: 'Associated with', m: 'æœ‰é—œè¯' },
                    { t: 'Linked to', m: 'æœ‰è¯ç¹«' },
                    { t: 'Related to', m: 'æœ‰é—œä¿‚' },
                    { t: 'Has to do with', m: 'èˆ‡..æœ‰é—œ' }
                ] 
            },
            // --- Group 12: æ¨¡ç³Š ---
            { 
                id: 'blurry', 
                color: '#607d8b', // Blue Grey
                meaning: 'æ¨¡ç³Š', 
                words: [
                    { t: 'Blurry', m: 'æ¨¡ç³Š(è¦–è¦º)' },
                    { t: 'Vague', m: 'å«ç³Š(æŠ½è±¡)' },
                    { t: 'Ambiguous', m: 'æ¨¡ç¨œå…©å¯' }
                ] 
            },
            // --- Group 13: æœ‰çˆ­è­°æ€§ ---
            { 
                id: 'controversial', 
                color: '#d35400', // Pumpkin
                meaning: 'æœ‰çˆ­è­°æ€§', 
                words: [
                    { t: 'Controversial', m: 'å…·çˆ­è­°æ€§' },
                    { t: 'Disputable', m: 'æœ‰å•†æ¦·é¤˜åœ°' },
                    { t: 'Debatable', m: 'å¯è¾¯è«–çš„' },
                    { t: 'Contentious', m: 'å¼•èµ·çˆ­è«–çš„' }
                ] 
            },
            // --- Group 14: å¾ˆå¤š ---
            { 
                id: 'numerous', 
                color: '#f39c12', // Orange
                meaning: 'å¾ˆå¤š', 
                words: [
                    { t: 'Numerous', m: 'çœ¾å¤š(å¯æ•¸)' },
                    { t: 'A myriad of', m: 'ç„¡æ•¸(å¯æ•¸)' },
                    { t: 'A plethora of', m: 'å¤šä¸å‹æ•¸(å¯æ•¸)' },
                    { t: 'A host of', m: 'è¨±å¤š(å¯æ•¸)' },
                    { t: 'A good many', m: 'å¾ˆå¤š(å¯æ•¸,å£èª)' },
                    { t: 'Quite a few', m: 'ç›¸ç•¶å¤š(å¯æ•¸)' },
                    { t: 'A great deal of', m: 'å¤§é‡(ä¸å¯æ•¸)' },
                    { t: 'A wealth of', m: 'å¤§é‡(æè±¡åè©)' },
                ] 
            },
            // --- Group 15: ç‰¹è³ª (åˆ†äººèˆ‡ç‰©) ---
            { 
                id: 'trait', 
                color: '#8e44ad', // Wisteria
                meaning: 'ç‰¹è³ª / ç‰¹å¾µ', 
                words: [
                    { t: 'Nature', m: 'æœ¬è³ª(ç‰©)' },
                    { t: 'Characteristics', m: 'ç‰¹å¾µ(ç‰©)' },
                    { t: 'Property', m: 'å±¬æ€§(ç‰©)' },
                    { t: 'Attribute', m: 'ç‰¹è³ª(ç‰©)' },
                    { t: 'Trait', m: 'ç‰¹å¾µ(äºº)' },
                    { t: 'Character', m: 'æ€§æ ¼(äºº)' }
                ] 
            },
            // --- Group 16: å±•ç¤º/é¡¯ç¤º ---
            { 
                id: 'show', 
                color: '#2980b9', // Belize Hole
                meaning: 'å±•ç¤º/é¡¯ç¤º', 
                words: [
                    { t: 'Display', m: 'å±•ç¤º(ç‰©å“)' },
                    { t: 'Demonstrate', m: 'å±•ç¤º(æè±¡)' },
                    { t: 'Reveal', m: 'é¡¯ç¤º' },
                    { t: 'Indicate', m: 'é¡¯ç¤º(æ•¸å­—)' },
                    { t: 'Exhibit', m: 'å±•ç¤º(ç‰©å“)' },
                    { t: 'Showcase', m: 'å±•ç¤º' }
                ] 
            },
            // --- Group 18: æ•™å ‚ (åˆ†å¤§å°) ---
            { 
                id: 'church', 
                color: '#8e44ad', // Purple
                meaning: 'æ•™å ‚ (åˆ†å¤§å°)', 
                words: [
                    { t: 'Chapel', m: 'å°æ•™å ‚/ç¦®æ‹œå ‚' },
                    { t: 'Church', m: 'æ•™å ‚(ä¸­)' },
                    { t: 'Cathedral', m: 'å¤§æ•™å ‚' },
                    { t: 'Basilica', m: 'å®—åº§è–æ®¿(è¶…å¤§)' }
                ] 
            },
            // --- Group 19: å¯ºå»Ÿ/å®—æ•™å ´æ‰€ ---
            { 
                id: 'temple', 
                color: 'darkmagenta', // Red
                meaning: 'å¯ºå»Ÿ / è–åœ°', 
                words: [
                    { t: 'Shrine', m: 'ç¥ç¤¾/ç¥é¾•(å°)' },
                    { t: 'Temple', m: 'å¯ºå»Ÿ' },
                    { t: 'Monastery', m: 'ä¿®é“é™¢/åƒ§é™¢' },
                    { t: 'Mosque', m: 'æ¸…çœŸå¯º' }
                ] 
            },
            // --- Group 20: è¿…é€Ÿ ---
            { 
                id: 'rapid', 
                color: '#e67e22', // Carrot
                meaning: 'è¿…é€Ÿ', 
                words: [
                    { t: 'Rapid', m: 'è¿…é€Ÿ(æ”¹è®Š)' },
                    { t: 'Swift', m: 'è¿…é€Ÿ(ç§»å‹•)' },
                    { t: 'Prompt', m: 'è¿…é€Ÿ(åæ‡‰)' }
                ] 
            },
            // --- Group 21: å®£ä½ˆ ---
            { 
                id: 'declare', 
                color: '#34495e', // Wet Asphalt
                meaning: 'å®£ä½ˆ', 
                words: [
                    { t: 'Declare', m: 'å®£ä½ˆ(æ­£å¼)' },
                    { t: 'Announce', m: 'å®£ä½ˆ' }
                ] 
            },
           { 
                id: 'utter', 
                color: 'darkkhaki',
                meaning: 'èªª', 
                words: [
                    { t: 'stress', m: 'å¼·èª¿èªª' },
                    { t: 'utter', m: 'èªª' },
                    { t: 'state', m: 'èªª' },
                    { t: 'remark', m: 'èªª(æ­£å¼)' }
                ] 
            },
            // --- Group 22: ç™¼ç”Ÿ ---
            { 
                id: 'happen', 
                color: '#16a085', // Green Sea
                meaning: 'ç™¼ç”Ÿ', 
                words: ['Happen', 'Occur', 'Take place', 'Arise'] 
            },
            // --- Group 23: é©…ä½¿/ä¿ƒé€² ---
            { 
                id: 'foster', 
                color: '#27ae60', // Nephritis
                meaning: 'ä¿ƒé€² / é©…ä½¿', 
                words: [
                    { t: 'Drive', m: 'é©…ä½¿' },
                    { t: 'Prompt', m: 'ä¿ƒä½¿' },
                    { t: 'Foster', m: 'åŸ¹é¤Š/ä¿ƒé€²' },
                    { t: 'Facilitate', m: 'ä¿ƒé€²/ä½¿ä¾¿åˆ©' },
                    { t: 'Promote', m: 'æ¨å»£/ä¿ƒé€²' }
                ] 
            },
            // --- Group 24: é¦™å‘³/æ°£å‘³ ---
            { 
                id: 'smell', 
                color: '#d2527f', // Pink
                meaning: 'é¦™å‘³', 
                words: [
                    { t: 'Aroma', m: 'é¦™æ°£(é£Ÿç‰©)' },
                    { t: 'Fragrance', m: 'èŠ¬èŠ³(é¦™æ°´/èŠ±)' },
                    { t: 'Scent', m: 'æ°£å‘³(ä¸­æ€§/å¥½)' }
                ] 
            },
            // --- Group 25: é–‹å¿ƒ ---
            { 
                id: 'joy', 
                color: '#f1c40f', // Sun Flower
                meaning: 'é–‹å¿ƒ / å–œæ‚…', 
                words: ['Pleasure', 'Delight', 'Joy', 'Glee'] 
            },
            // --- Group 26: å› æ­¤ ---
            { 
                id: 'therefore', 
                color: '#7f8c8d', // Concrete
                meaning: 'å› æ­¤', 
                words: ['Thus', 'Hence', 'Therefore'] 
            },
            // --- Group 27: ç†±è¡·æ–¼ ---
            { 
                id: 'enthusiastic', 
                color: '#e74c3c', // Alizarin
                meaning: 'ç†±è¡·æ–¼', 
                words: [
                    { t: 'Enthusiastic about', m: 'ç†±è¡·' },
                    { t: 'Passionate about', m: 'å……æ»¿ç†±èª ' },
                    { t: 'Keen to', m: 'æ¸´æœ›/ç†±è¡·' }
                ] 
            },
            // --- Group 28: ç¦æ­¢ ---
            { 
                id: 'ban', 
                color: '#c0392b', // Old Brick
                meaning: 'ç¦æ­¢', 
                words: ['Forbid', 'Ban', 'Bar', 'Prohibit'] 
            },
            // --- Group 29: æ„è­˜åˆ° ---
            { 
                id: 'aware', 
                color: '#2980b9', // Blue
                meaning: 'æ„è­˜åˆ°', 
                words: [
                    { t: 'Be aware of', m: 'æ„è­˜åˆ°' },
                    { t: 'Realise', m: 'æ„è­˜åˆ°/å¯¦ç¾' },
                    { t: 'Be conscious of', m: 'å¯Ÿè¦ºåˆ°' }
                ] 
            },
            // --- Group 30: å¦å¤– ---
            { 
                id: 'addition', 
                color: '#8e44ad', // Purple
                meaning: 'å¦å¤– / æ­¤å¤–', 
                words: ['In addition', 'Furthermore', 'Moreover', 'Besides', 'On top of that', 'Plus'] 
            },
            // --- Group 31: æ˜é¡¯ ---
            { 
                id: 'obvious', 
                color: '#f39c12', // Orange
                meaning: 'æ˜é¡¯', 
                words: ['Obvious', 'Apparent', 'Evident', 'Conspicuous', 'Clear'] 
            },
            // --- Group 32: é©æ‡‰ ---
            { 
                id: 'adapt', 
                color: '#2ecc71', // Green
                meaning: 'é©æ‡‰', 
                words: [
                    { t: 'Adapt to', m: 'é©æ‡‰' },
                    { t: 'Get used to', m: 'ç¿’æ…£' },
                    { t: 'Get accustomed to', m: 'ç¿’æ…£æ–¼' }
                ] 
            },
            // --- Group 33: æ¡ç”¨/å¯¦æ–½ ---
            { 
                id: 'adopt', 
                color: '#34495e', // Navy
                meaning: 'æ¡ç”¨ / å¯¦æ–½', 
                words: [
                    { t: 'Adopt', m: 'æ¡ç”¨' },
                    { t: 'Introduce', m: 'å¼•å…¥' },
                    { t: 'Launch', m: 'æ¨è¡Œ' },
                    { t: 'Implement', m: 'å¯¦æ–½(è¨ˆåŠƒ)' },
                    { t: 'Impose', m: 'å¼·åˆ¶å¯¦æ–½(-)' }
                ] 
            },
            // --- Group 34: å¯è¡Œçš„ ---
            { 
                id: 'feasible', 
                color: '#27ae60', // Green
                meaning: 'å¯è¡Œçš„', 
                words: ['Feasible', 'Viable', 'Workable'] 
            }
        ];

        // --- éŠæˆ²è®Šæ•¸ ---
        let hasFlippedCard = false, lockBoard = false;
        let firstCard, secondCard, matchedPairs = 0;
        let lives = 10, timer, timeLimit = 100, remainingTime = 100;
        let currentLevel = 1, totalScore = 0;
        let sessionHistory = [];
        let globalPairDeck = []; 
        let lastGameEndReason = "";
        let lastGameRank = "è¨ˆç®—ä¸­..."; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- ç™»å…¥ç³»çµ±é‚è¼¯ ---
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('synonym_player');
            if (savedUser) {
                currentPlayer = savedUser;
                showGameUI();
                backToLobby();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function handleLogin() {
            const inputName = document.getElementById('loginNameInput').value.trim();
            const loginBtn = document.querySelector('.btn-login');

            if (!inputName) { alert("è«‹è¼¸å…¥åå­—"); return; }
            if (inputName.length > 12) { alert("åå­—å¤ªé•·å•¦ (é™12å­—)"); return; }
            if (!db) { alert("âŒ è³‡æ–™åº«æœªé€£æ¥"); return; }

            const originalText = loginBtn.innerText;
            loginBtn.innerText = "é€£ç·šä¸­...";
            loginBtn.disabled = true;

            db.ref(USERS_PATH + '/' + inputName).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    const confirmLogin = confirm(`åå­— "${inputName}" å·²å­˜åœ¨ã€‚æ˜¯æœ¬äººè«‹æŒ‰ç¢ºå®šï¼Œå¦å‰‡è«‹æ”¹åã€‚`);
                    if (confirmLogin) loginSuccess(inputName);
                    else { loginBtn.innerText = originalText; loginBtn.disabled = false; }
                } else {
                    db.ref(USERS_PATH + '/' + inputName).set({ createdAt: firebase.database.ServerValue.TIMESTAMP })
                    .then(() => { alert(`é¡˜ä½ èˆ‡é¬¼ç‹åŒåœ¨ï¼${inputName}ï¼`); loginSuccess(inputName); });
                }
            })
            .catch(error => {
                alert("âŒ é€£ç·šéŒ¯èª¤: " + error.message);
                loginBtn.innerText = originalText; loginBtn.disabled = false;
            });
        }

        function loginSuccess(name) {
            currentPlayer = name;
            localStorage.setItem('synonym_player', name); 
            document.getElementById('loginModal').classList.add('hidden');
            showGameUI();
            backToLobby(); 
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('synonym_player');
                location.reload(); 
            }
        }

        function showGameUI() {
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('currentUserDisplay').innerText = currentPlayer;
            document.getElementById('loginModal').classList.add('hidden'); 
        }

        // --- éŸ³æ•ˆ ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'flip') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'match') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'victory') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = 'square'; o.frequency.value = freq;
                    g.gain.setValueAtTime(0.05, now + i*0.1); g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.4);
                });
            } else if (type === 'gameover') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now + 1.5);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(now); osc.stop(now + 1.5);
            }
        }

        // --- å„ªåŒ–ç‰ˆç™¼éŸ³ç³»çµ± ---
        let allVoices = [];
        function loadVoices() {
            allVoices = window.speechSynthesis.getVoices();
        }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speakWord(text) {
            if (!('speechSynthesis' in window)) {
                alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½");
                return;
            }
            if (allVoices.length === 0) allVoices = window.speechSynthesis.getVoices();

            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            
            let preferredVoice = allVoices.find(v => v.name.includes("Google US English")) ||
                                 allVoices.find(v => v.name.includes("Google UK English Female")) ||
                                 allVoices.find(v => v.name.includes("Microsoft Zira")) ||
                                 allVoices.find(v => v.lang === 'en-US' && !v.name.includes("Chinese")) ||
                                 allVoices.find(v => v.lang === 'en-GB');

            if (preferredVoice) u.voice = preferredVoice;
            u.lang = 'en-US'; u.rate = 0.9; u.pitch = 1;
            window.speechSynthesis.speak(u);
        }
        loadVoices();

        // --- éŠæˆ²é‚è¼¯ ---
 // ------------------------------------------------------------------
        // ğŸ¤– Google Gemini AI è¨­å®š (æœ€æ–°ä¿®å¾©ç‰ˆ)
        // ------------------------------------------------------------------
        
        // ------------------------------------------------------------------
        // ğŸ® éŠæˆ²æ ¸å¿ƒé‚è¼¯ (å®Œæ•´ä¿®å¾©ç‰ˆ)
        // ------------------------------------------------------------------
        function generateMasterDeck() {
            let tempDeck = [];
            synonymData.forEach(g => {
                let ws = g.words.map(w => (typeof w === 'string') ? {t:w, m:g.meaning} : {t:w.t, m:w.m});
                ws.sort(() => 0.5 - Math.random());
                for (let i = 0; i < ws.length - 1; i += 2) {
                    tempDeck.push({ i1: ws[i], i2: ws[i+1], gid: g.id, c: g.color });
                }
            });
            return tempDeck.sort(() => 0.5 - Math.random());
        }
        
        function initGame(isNextLevel = false) {
            if (!currentPlayer) return; 

            const grid = document.getElementById('gameGrid');
            grid.innerHTML = '';
            hasFlippedCard = false; lockBoard = false; firstCard = null; secondCard = null; matchedPairs = 0;
            
            if (!isNextLevel) { 
                currentLevel = 1; totalScore = 0; lives = 3; 
                globalPairDeck = generateMasterDeck(); 
                sessionHistory = []; 
            } else { 
                currentLevel++; 
                lives = Math.min(lives + 1, 3); 
            }

            if (globalPairDeck.length < 8) globalPairDeck = globalPairDeck.concat(generateMasterDeck());

            updateUI(); resetTimer(); startTimer();

            const selectedPairs = globalPairDeck.splice(0, 8);

            sessionHistory.push({
                level: currentLevel,
                pairs: selectedPairs.map(p => ({
                    gid: p.gid,
                    words: [p.i1.t, p.i2.t], 
                    color: p.c,
                    meaning: p.i1.m
                }))
            });

            let deck = [];
            selectedPairs.forEach(p => {
                deck.push({t:p.i1.t, m:p.i1.m, gid:p.gid, c:p.c}, {t:p.i2.t, m:p.i2.m, gid:p.gid, c:p.c});
            });
            
            deck.sort(()=>0.5-Math.random());

deck.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('card');
                
                card.dataset.group = item.gid; 
                card.dataset.word = item.t; 
                card.dataset.color = item.c; 
                card.dataset.failCount = 1;

                const displayWord = item.t.charAt(0).toUpperCase() + item.t.slice(1);
                
                let hintLetter = "";

                if (item.t.charAt(1) === ' ') {
                    hintLetter = item.t.charAt(0).toUpperCase() + " " + item.t.charAt(2).toLowerCase();
                } else {
                    hintLetter = item.t.charAt(0).toUpperCase() + item.t.charAt(1).toLowerCase();
                }
                const textClass = item.t.length > 12 ? 'word-text long-text' : 'word-text';
                
                card.innerHTML = `<div class="card-inner">
                    <div class="card-front">
                        <div class="${textClass}">${displayWord}</div>
                        <div class="meaning-text">${item.m}</div>
                    </div>
                    <div class="card-back">${hintLetter}</div>
                </div>`;
                
                card.addEventListener('click', flipCard);
                grid.appendChild(card);
            });

            setTimeout(() => { if(grid.children.length) grid.children[Math.floor(Math.random()*grid.children.length)].click(); }, 600);
        }

        function updateUI() {
            let h = ""; for(let i=0; i<lives; i++) h+="â¤ï¸";
            const l = document.getElementById('lives');
            l.innerText = h || "ğŸ’€";
            l.className = lives<=2 ? "stat-box low-health" : "stat-box";
            document.getElementById('total-score').innerText = totalScore;
            document.getElementById('level-display').innerText = currentLevel;
        }

        function flipCard() {
            if (lockBoard || this === firstCard) return;
            playSound('flip'); this.classList.add('flipped'); speakWord(this.dataset.word);
            if (!hasFlippedCard) { hasFlippedCard = true; firstCard = this; return; }
            secondCard = this; checkForMatch();
        }

        function checkForMatch() {
            const w1 = firstCard.dataset.word;
            const w2 = secondCard.dataset.word;

            if (isSynonymPair(w1, w2)) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function isSynonymPair(wordA, wordB) {
            if (!wordA || !wordB) return false;
            const wa = wordA.toLowerCase();
            const wb = wordB.toLowerCase();
            if (wa === wb) return true;
            for (let group of synonymData) {
                const wordsInGroup = group.words.map(w => (typeof w === 'string' ? w : w.t).toLowerCase());
                if (wordsInGroup.includes(wa) && wordsInGroup.includes(wb)) return true; 
            }
            return false;
        }

        function disableCards() {
            const c1 = firstCard;
            const c2 = secondCard;
            const color = c1.dataset.color || '#333';

            c1.removeEventListener('click', flipCard); 
            c2.removeEventListener('click', flipCard);

            setTimeout(() => {
                playSound('match'); 
                c1.classList.add('matched'); 
                c2.classList.add('matched');
                
                [c1, c2].forEach(c => {
                    const f = c.querySelector('.card-front');
                    const w = c.querySelector('.word-text');
                    const m = c.querySelector('.meaning-text');
                    f.setAttribute('style', `background-color:#fff!important; border:3px solid ${color}!important; color:${color}!important; transform:rotateY(180deg); box-shadow:inset 0 0 0 1px ${color}20;`);
                    w.style.color = color; 
                    if(m) m.style.cssText = `color:${color}!important; opacity:1!important; transform:translateY(0)!important; display:block!important;`;
                });
            }, 300);

            matchedPairs++;
            totalScore += 10; 
            updateUI(); 

            if (matchedPairs === 8) {
                clearInterval(timer);
                totalScore += remainingTime + (lives * 10);
                document.getElementById('total-score').innerText = totalScore;
                setTimeout(() => {
                    playSound('victory');
                    alert(`ğŸ‰ Level ${currentLevel} Complete! åŠ ç•ª1å€‹â¤ï¸ä¿¾ä½ !\nç¸½åˆ†: ${totalScore}`);
                    initGame(true);
                }, 800);
            }
            resetBoard();
        }

        function unflipCards() {
            lockBoard = true; 
            const c1 = firstCard;
            const c2 = secondCard;
            
            [c1, c2].forEach(c => {
                let cnt = parseInt(c.dataset.failCount||1)+1; 
                c.dataset.failCount = cnt;
                let w = c.dataset.word;
                let rawHint = w.substring(0, Math.min(cnt, w.length));
                let hint = rawHint.charAt(0).toUpperCase() + rawHint.slice(1);
                let b = c.querySelector('.card-back'); 
                if(b) {
                    b.innerText = hint;
                    b.style.fontSize = hint.length>3?'1rem':(hint.length>1?'1.5rem':'2.5rem');
                    b.style.background = "linear-gradient(135deg, #5b6ebf 0%, #683e91 100%)";
                }
            });

            lives--; 
            updateUI();

            if (lives === 0) {
                revealAndEndGame('HP æ­¸é›¶'); 
                return;
            }

            setTimeout(() => { 
                playSound('fail'); 
                c1.classList.add('shake'); 
                c2.classList.add('shake'); 
            }, 400);
            
            setTimeout(() => { 
                c1.classList.remove('flipped','shake'); 
                c2.classList.remove('flipped','shake'); 
                resetBoard(); 
            }, 1200);
        }

        function resetBoard() { [hasFlippedCard, lockBoard] = [false, false]; [firstCard, secondCard] = [null, null]; }
        
        function startTimer() {
            remainingTime = timeLimit; document.getElementById('timer').innerText = remainingTime;
            timer = setInterval(() => {
                remainingTime--; document.getElementById('timer').innerText = remainingTime;
                if (remainingTime <= 0) { 
                    revealAndEndGame('æ™‚é–“åˆ°'); 
                }
            }, 1000);
        }
        function resetTimer() { clearInterval(timer); remainingTime = timeLimit; document.getElementById('timer').innerText = remainingTime; }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šçµæŸèˆ‡å›é¡§ ---

        // 1. è¼¸æ‰/çµæŸæ™‚çš„è™•ç†
        function revealAndEndGame(reason) {
            clearInterval(timer);
            lastGameEndReason = reason;
            
            playSound('gameover');
            lockBoard = true;

            const giveUpBtn = document.getElementById('btn-giveup');
            if(giveUpBtn) giveUpBtn.style.display = 'none';
            
            const reviewBtn = document.getElementById('btn-review-level');
            if(reviewBtn) {
                reviewBtn.style.display = 'flex';
                reviewBtn.classList.remove('pop-active');
                void reviewBtn.offsetWidth; // Trigger reflow
                reviewBtn.classList.add('breathing-btn'); 
            }

            const unmatchedCards = document.querySelectorAll('.card:not(.matched)');
            unmatchedCards.forEach(card => {
                card.classList.add('flipped'); 
                const color = card.dataset.color;
                const front = card.querySelector('.card-front');
                const wordText = card.querySelector('.word-text');
                const meaningText = card.querySelector('.meaning-text');

                front.setAttribute('style', `
                    background-color: #fff !important; 
                    border: 3px solid ${color} !important; 
                    color: ${color} !important; 
                    transform: rotateY(180deg);
                    box-shadow: 0 0 15px rgba(0,0,0,0.1);
                `);

                if(wordText) wordText.style.color = color;
                if(meaningText) {
                    meaningText.style.cssText = `
                        color: ${color} !important; 
                        opacity: 1 !important; 
                        transform: translateY(0) !important; 
                        display: block !important;
                    `;
                }
            });

            autoSubmitScore(true);
        }

        // 2. æŒ‰éˆ•è§¸ç™¼
        function goToResultPage() {
            showResultPage(lastGameEndReason);
        }

        // 3. é¡¯ç¤ºçµæœé  (æ–°ç‰ˆ)
        function showResultPage(reason) {
            closeModal('rankModal'); 
            
            const container = document.getElementById('resultListContainer');
            container.innerHTML = ''; 

            // A. åˆ†æ•¸é¢æ¿
            const dashboard = document.createElement('div');
            dashboard.style.cssText = "text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px dashed #ddd;";
            
            let rankDisplay = `#${lastGameRank}`;
            if(lastGameRank == 1) rankDisplay = "ğŸ† å† è»";
            if(lastGameRank == 2) rankDisplay = "ğŸ¥ˆ äºè»";
            if(lastGameRank == 3) rankDisplay = "ğŸ¥‰ å­£è»";

            dashboard.innerHTML = `
                <div style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 5px;">è¾›è‹¦æ›¬ï¼æœ¬æ¬¡å¾—åˆ†ç‚º</div>
                <div style="font-size: 3rem; font-weight: 900; color: #e74c3c; line-height: 1.2; margin: 5px 0;">
                    ${totalScore}
                </div>
                <div id="resultPageRankDisplay" style="font-size: 1.1rem; font-weight: bold; color: #f39c12; background: #fffbf0; display:inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid #f1c40f;">
                     æœ¬æ¬¡æ’å: ${rankDisplay}
                </div>
            `;
            container.appendChild(dashboard);

            // B. åˆ—è¡¨
            if(sessionHistory.length === 0) {
                container.innerHTML += '<p style="text-align:center;">ç„¡éŠæˆ²ç´€éŒ„</p>';
            }

            [...sessionHistory].reverse().forEach(record => {
                const levelTitle = document.createElement('div');
                levelTitle.className = 'result-level-title';
                levelTitle.innerText = `Level ${record.level}`;
                container.appendChild(levelTitle);

                record.pairs.forEach(pair => {
                    const fullGroupData = synonymData.find(g => g.id === pair.gid);
                    
                    const groupBox = document.createElement('div');
                    groupBox.className = 'result-group-box';
                    groupBox.style.borderColor = pair.color;

                    const meaningDiv = document.createElement('div');
                    meaningDiv.className = 'result-meaning';
                    meaningDiv.style.color = pair.color;

                    const allWordsInGroup = fullGroupData ? fullGroupData.words : pair.words;
                    const meaningText = fullGroupData ? fullGroupData.meaning : 'æ„æ€';

                    const textSpan = document.createElement('span');
                    textSpan.innerText = meaningText;
                    meaningDiv.appendChild(textSpan); // æ”¾ text å…¥å»

                    const aiBtn = document.createElement('button');
                    aiBtn.className = 'ai-btn';
                    aiBtn.innerHTML = 'âœ¨ åˆ†ææ­¤çµ„å­—';
                    aiBtn.onclick = function() { askGemini(this, meaningText, allWordsInGroup); };
                
                    meaningDiv.appendChild(aiBtn); 

                    groupBox.appendChild(meaningDiv);

                    const wordsFlex = document.createElement('div');
                    wordsFlex.className = 'result-words-flex';

                    pair.words.forEach(wordText => {
                        const badge = createWordBadge(wordText, pair.color, true);
                        wordsFlex.appendChild(badge);
                    });

                    if(fullGroupData) {
                        fullGroupData.words.forEach(w => {
                            const wText = (typeof w === 'string') ? w : w.t;
                            if (!pair.words.includes(wText)) {
                                const badge = createWordBadge(wText, '#95a5a6', false);
                                wordsFlex.appendChild(badge);
                            }
                        });
                    }

                    groupBox.appendChild(wordsFlex);
                    container.appendChild(groupBox);
                });
            });

            document.getElementById('resultModal').classList.remove('hidden');
        }

        // --- æ’è¡Œæ¦œèˆ‡åˆ†æ•¸ ---
        function autoSubmitScore(isSilent = false) {
            if (!currentPlayer) return;
            
            if (totalScore === 0) {
                 if (!isSilent) {
                     alert("ğŸ’€ Game Over! \n0åˆ†... ä¸‹æ¬¡åŠªåŠ›ï¼");
                     backToLobby();
                 }
                 return;
            }

            db.ref(LEADERBOARD_PATH).push({
                name: currentPlayer,
                score: totalScore,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                calculateMyRank(); 
            });
        }


        function calculateMyRank() {
            lastGameRank = "..."; 
            
            db.ref(LEADERBOARD_PATH).orderByChild('score').once('value', snapshot => {
                let rawScores = [];
                snapshot.forEach(child => {
                    rawScores.push(child.val());
                });
                
                // --- ğŸ”¥ åŒæ¨£æ‡‰ç”¨éæ¿¾é‚è¼¯ ---
                const uniqueMap = {};
                rawScores.forEach(item => {
                    if (!uniqueMap[item.name] || item.score > uniqueMap[item.name].score) {
                        uniqueMap[item.name] = item;
                    }
                });
                
                // è½‰æˆ Array ä¸¦æ’åº
                let uniqueScores = Object.values(uniqueMap).sort((a, b) => b.score - a.score);

                // æ‰¾å‡ºè‡ªå·±åœ¨æ¦œå–®ä¸­çš„ä½ç½®
                let myRank = "æœªä¸Šæ¦œ";
                for (let i = 0; i < uniqueScores.length; i++) {
                    if (uniqueScores[i].name === currentPlayer) {
                        myRank = i + 1;
                        break;
                    }
                }
                
                lastGameRank = myRank;

                // ç«‹å³æ›´æ–° UI (å¦‚æœçµæœé å·²ç¶“æ‰“é–‹)
                const displayDiv = document.getElementById('resultPageRankDisplay');
                if (displayDiv) {
                    let rankText = (typeof myRank === 'number') ? `#${myRank}` : myRank;
                    
                    if(myRank == 1) rankText = "ğŸ† å† è»";
                    if(myRank == 2) rankText = "ğŸ¥ˆ äºè»";
                    if(myRank == 3) rankText = "ğŸ¥‰ å­£è»";
                    
                    displayDiv.innerText = `æœ¬æ¬¡æ’å: ${rankText}`;
                }
            });
        }

        function openRankModal() {
            document.getElementById('rankModal').classList.remove('hidden');
            fetchLeaderboard();
        }

       function fetchLeaderboard() {
            const listBody = document.getElementById('rankListBody');
            const loading = document.getElementById('loadingRank');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            loading.style.display = 'block';
            listBody.innerHTML = '';

            // ç²å–æœ€å¾Œ 100 ç­†æ•¸æ“š
            db.ref(LEADERBOARD_PATH).orderByChild('score').limitToLast(100).once('value')
            .then(snapshot => {
                loading.style.display = 'none';
                
                let rawScores = [];
                snapshot.forEach(child => { rawScores.push(child.val()); });
                
                // éæ¿¾é‡è¤‡åå­—ï¼Œåªç•™æœ€é«˜åˆ†
                const uniqueMap = {};
                rawScores.forEach(item => {
                    if (!uniqueMap[item.name] || item.score > uniqueMap[item.name].score) {
                        uniqueMap[item.name] = item;
                    }
                });

                // æ’åº
                let uniqueScores = Object.values(uniqueMap).sort((a, b) => b.score - a.score);

                if(uniqueScores.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">æš«ç„¡ç´€éŒ„</td></tr>';
                    return;
                }

                uniqueScores.forEach((s, index) => {
                    const row = document.createElement('tr');
                    row.className = 'rank-row';
                    
                    let rankIcon = `<span class="rank-num">${index + 1}</span>`;
                    if(index===0) rankIcon = 'ğŸ¥‡';
                    if(index===1) rankIcon = 'ğŸ¥ˆ';
                    if(index===2) rankIcon = 'ğŸ¥‰';

                    const isMe = (s.name === currentPlayer) ? 'background:#fffde7;' : '';

                    row.innerHTML = `
                        <td style="${isMe}">${rankIcon}</td>
                        <td class="rank-name" style="${isMe}">${s.name}</td>
                        <td class="rank-score" style="${isMe}">${s.score}</td>
                    `;
                    listBody.appendChild(row);
                });
            }) // é€™è£¡æ­£ç¢ºé–‰åˆ .then
            .catch(err => {
                loading.innerText = "è¼‰å…¥å¤±æ•—";
                console.error(err);
            }); // é€™è£¡æ­£ç¢ºé–‰åˆ .catch
        }

        // --- å°èˆªèˆ‡ä»‹é¢æ§åˆ¶ ---
        function backToLobby() {
            clearInterval(timer);
            lockBoard = false; hasFlippedCard = false;
            document.getElementById('gameGrid').innerHTML = ''; 
            document.getElementById('startOverlay').style.display = 'block'; 
            document.getElementById('preGameButtons').style.display = 'flex';
            document.getElementById('inGameButtons').style.display = 'none';
            document.getElementById('timer').innerText = timeLimit;
            document.getElementById('lives').innerText = "â¤ï¸â¤ï¸â¤ï¸";
            lives = 10;
        }

        function onGiveUp() {
            if(confirm("ç¢ºå®šè¦æ”¾æ£„éŠæˆ²ä¸¦çµç®—åˆ†æ•¸å—ï¼Ÿ")) {
                revealAndEndGame('ä¸»å‹•æ”¾æ£„');
            }
        }

        function startGameSession() {
            // ğŸ”¥ ä¿®æ”¹é»ï¼šå†ä¾†ä¸€å±€æ™‚ï¼Œå¼·åˆ¶é—œé–‰ Result Modal
            document.getElementById('resultModal').classList.add('hidden');
            
            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('preGameButtons').style.display = 'none';
            const inGameBtns = document.getElementById('inGameButtons');
            inGameBtns.style.display = 'flex';    
            document.getElementById('btn-giveup').style.display = 'flex'; 
            document.getElementById('btn-review-level').style.display = 'none'; 

            initGame(false);
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'rankModal' && lives <= 0) {
                backToLobby();
            }
        }

        function closeResultAndReset() {
            document.getElementById('resultModal').classList.add('hidden');
            backToLobby(); 
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                if (currentLevel > 0 && totalScore > 0 && document.getElementById('inGameButtons').style.display === 'flex') {
                    console.log("App hidden, auto saving score...");
                    autoSubmitScore(true);
                }
            }
        });

        // è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹å–®å­— Badge
        function createWordBadge(text, color, isActive) {
            const span = document.createElement('span');
            span.innerText = text;
            span.className = isActive ? 'word-badge active' : 'word-badge passive';
            if (isActive) span.style.backgroundColor = color;
            span.onclick = () => {
                speakWord(text);
                span.style.transform = "scale(0.9)";
                setTimeout(()=> span.style.transform = isActive ? "scale(1)" : "scale(1)", 100);
            };
            return span;
        }

        // --- æº«ç¿’è¡¨åŠŸèƒ½ ---
// --- æº«ç¿’è¡¨åŠŸèƒ½ (å·²ä¿®å¾©ï¼šé¡¯ç¤ºå€‹åˆ¥å­—ç¾© + é»æ“Šå‹•ç•« + ç§»é™¤å–‡å­åœ–ç¤º) ---
        // --- æº«ç¿’è¡¨åŠŸèƒ½ (å·²æ›´æ–°ï¼šæ”¯æ´å‹•æ…‹é¡è‰²å…‰) ---
function openStudyModal() {
            const container = document.getElementById('studyListContainer');
            container.innerHTML = '';
            
            const searchWrapper = document.getElementById('searchBarWrapper');
            const searchInput = document.getElementById('studySearchInput');
            if(searchWrapper) searchWrapper.classList.remove('open');
            if(searchInput) searchInput.value = '';

            synonymData.sort((a,b) => a.id.localeCompare(b.id));

            synonymData.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'study-group';
                groupDiv.style.borderLeftColor = group.color;

                const meaningDiv = document.createElement('div');
                meaningDiv.className = 'study-meaning';
                meaningDiv.style.color = group.color;
                
                // ğŸ”¥ å®‰å…¨å¯«æ³•ï¼šå…ˆæ”¾æ–‡å­—ï¼Œå†ç”¨ JS å»ºç«‹æŒ‰éˆ•ï¼Œé¿å…å¼•è™Ÿè¡çª
                meaningDiv.innerText = group.meaning + ' '; // åŠ å€‹ç©ºæ ¼

                const aiBtn = document.createElement('button');
                aiBtn.className = 'ai-btn';
                aiBtn.innerHTML = 'âœ¨ä½œæ–‡é»ç”¨';
                // ç›´æ¥ç¶å®šå‡½æ•¸ï¼Œå””æ´—ç¶“ HTML string
                aiBtn.onclick = function() { askGemini(this, group.meaning, group.words); };
                
                meaningDiv.appendChild(aiBtn); // å°‡æŒ‰éˆ•æ”¾å…¥å»
                groupDiv.appendChild(meaningDiv);

                const wordsDiv = document.createElement('div');
                wordsDiv.className = 'study-words';

                group.words.forEach(w => {
                    const span = document.createElement('span');
                    span.className = 'study-tag';
                    span.style.setProperty('--pop-color', group.color);

                    let textToSpeak = (typeof w === 'string') ? w : w.t;
                    let displayHtml = (typeof w === 'string') ? w : `${w.t} <small style="color:#7f8c8d; font-weight:normal; font-size: 0.85em;">(${w.m})</small>`;

                    span.innerHTML = displayHtml;
                    span.onclick = () => {
                        speakWord(textToSpeak);
                        span.classList.remove('pop-active');
                        void span.offsetWidth;
                        span.classList.add('pop-active');
                    };
                    wordsDiv.appendChild(span);
                });

                groupDiv.appendChild(wordsDiv);
                container.appendChild(groupDiv);
            });

            document.getElementById('studyModal').classList.remove('hidden');
        }

        function toggleSearchBar() {
            const wrapper = document.getElementById('searchBarWrapper');
            const input = document.getElementById('studySearchInput');
            if (wrapper.classList.contains('open')) {
                wrapper.classList.remove('open');
                input.value = ''; filterStudyList('');
            } else {
                wrapper.classList.add('open');
                input.focus();
            }
        }

        document.getElementById('studySearchInput').addEventListener('input', function(e) {
            filterStudyList(e.target.value);
        });

        function filterStudyList(keyword) {
            const groups = document.querySelectorAll('.study-group');
            keyword = keyword.toLowerCase();
            groups.forEach(group => {
                const text = group.innerText.toLowerCase();
                if (text.includes(keyword)) group.style.display = 'block';
                else group.style.display = 'none';
            });
        }

        checkLoginStatus();

    </script>
</body>
</html>
